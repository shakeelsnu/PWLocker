<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Password Locker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <!-- Firebase SDK imports -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, addDoc, getDoc, collection, query, where, onSnapshot, deleteDoc, updateDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Variables for Firebase objects
    let db, auth;
    let userId;
    let passwordsUnsubscribe = null;

    // Use environment variables for Firebase configuration and authentication
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // UI Elements
    const authContainer = document.getElementById('auth-container');
    const loginSection = document.getElementById('login-section');
    const loginBtn = document.getElementById('loginBtn');
    const signupBtn = document.getElementById('signupBtn');
    const forgotBtn = document.getElementById('forgotBtn');
    const mobileInput = document.getElementById('mobileInput');
    const countryCode = document.getElementById('countryCode');
    const passwordInput = document.getElementById('passwordInput');
    const mobileError = document.getElementById('mobileError');
    const userIdDisplay = document.getElementById('userIdDisplay');
    const userIdContainer = document.getElementById('user-id-container');
    const passwordManager = document.getElementById('password-manager');
    const savedList = document.getElementById('savedList');
    const addPasswordForm = document.getElementById('add-password-form');
    const newWebsiteInput = document.getElementById('newWebsite');
    const newUsernameInput = document.getElementById('newUsername');
    const newPasswordInput = document.getElementById('newPassword');
    const exportBtn = document.getElementById('exportBtn');
    const importFile = document.getElementById('importFile');
    const logoutBtn = document.getElementById('logoutBtn');

    // --- Utility Functions ---

    /**
     * Shows a toast notification.
     * @param {string} message The message to display.
     * @param {string} type The type of toast ('success' or 'error').
     */
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `p-3 rounded-xl shadow-lg text-white ${type === 'success' ? 'bg-green-600' : 'bg-red-600'} transform translate-y-2 opacity-0 transition-all duration-300`;
      toast.innerText = message;
      document.getElementById('toast-container').appendChild(toast);

      // Animate the toast in and out
      setTimeout(() => {
        toast.style.transform = 'translateY(0)';
        toast.style.opacity = '1';
      }, 10);
      setTimeout(() => {
        toast.style.transform = 'translateY(2rem)';
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    /**
     * Shows a custom modal dialog.
     * @param {string} title Modal title.
     * @param {string} message Modal message.
     * @param {Array<{text: string, className: string, action: function}>} actions Array of button objects.
     */
    function showModal(title, message, actions = []) {
      const modal = document.getElementById('customModal');
      const modalTitle = document.getElementById('modalTitle');
      const modalMessage = document.getElementById('modalMessage');
      const modalActions = document.getElementById('modalActions');

      modalTitle.innerText = title;
      modalMessage.innerText = message;
      modalActions.innerHTML = '';

      actions.forEach(action => {
        const button = document.createElement('button');
        button.innerText = action.text;
        button.className = `font-bold py-2 px-4 rounded-lg transition duration-300 ${action.className}`;
        button.onclick = () => {
          modal.classList.add('hidden');
          if (action.action) action.action();
        };
        modalActions.appendChild(button);
      });
      modal.classList.remove('hidden');
    }

    /**
     * Validates the mobile number based on country code.
     * @param {string} number The mobile number input.
     * @returns {boolean}
     */
    function validateMobile(number) {
      const countryOption = countryCode.options[countryCode.selectedIndex];
      const expectedLength = parseInt(countryOption.dataset.length);
      const digitsOnly = number.replace(/\D/g, '');
      return digitsOnly.length === expectedLength;
    }

    /**
     * Renders the list of passwords from the provided data array.
     * @param {Array} passwordsArray The array of password objects.
     */
    function renderPasswords(passwordsArray) {
      savedList.innerHTML = '';
      if (passwordsArray.length === 0) {
        savedList.innerHTML = '<p class="text-center text-gray-500 italic">No passwords saved yet.</p>';
      }
      passwordsArray.forEach(item => {
        const div = document.createElement('div');
        div.className = 'border border-gray-200 rounded-xl p-4 bg-white shadow-sm flex flex-col sm:flex-row sm:justify-between sm:items-center';
        div.innerHTML = `
          <div class="mb-2 sm:mb-0">
            <p class="font-semibold text-gray-800">${item.website}</p>
            <p class="text-sm text-gray-600">Username: <span class="font-mono">${item.username}</span></p>
            <p class="text-sm text-gray-600">Password: <span class="font-mono">${item.password}</span></p>
          </div>
          <button class="bg-red-500 text-white font-bold px-4 py-2 rounded-lg hover:bg-red-600 transition duration-300 self-end sm:self-center" onclick="deletePassword('${item.id}')">Delete</button>
        `;
        savedList.appendChild(div);
      });
    }

    // --- Firestore Functions ---

    /**
     * Adds a new password to Firestore.
     * @param {object} passwordData
     */
    async function addPassword(passwordData) {
      if (!userId) return;
      try {
        await addDoc(collection(db, `artifacts/${appId}/users/${userId}/passwords`), passwordData);
        showToast('Password saved successfully!');
      } catch (error) {
        console.error("Error adding document: ", error);
        showToast('Error saving password.', 'error');
      }
    }

    /**
     * Deletes a password from Firestore.
     * @param {string} passwordId The document ID of the password to delete.
     */
    window.deletePassword = (passwordId) => {
      showModal(
        'Delete Password',
        'Are you sure you want to delete this password?',
        [
          { text: 'Cancel', className: 'bg-gray-200 text-gray-800 hover:bg-gray-300' },
          { text: 'Delete', className: 'bg-red-500 text-white hover:bg-red-600', action: async () => {
              if (!userId) return;
              try {
                await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/passwords`, passwordId));
                showToast('Password deleted successfully!');
              } catch (error) {
                console.error("Error deleting document: ", error);
                showToast('Error deleting password.', 'error');
              }
            }
          }
        ]
      );
    };

    /**
     * Sets up a real-time listener for passwords in Firestore.
     */
    function setupPasswordListener() {
      if (!db || !userId) return;
      // Detach previous listener if it exists
      if (passwordsUnsubscribe) {
        passwordsUnsubscribe();
      }
      const passwordsColRef = collection(db, `artifacts/${appId}/users/${userId}/passwords`);
      passwordsUnsubscribe = onSnapshot(passwordsColRef, (snapshot) => {
        const passwords = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderPasswords(passwords);
      }, (error) => {
        console.error("Error listening to passwords: ", error);
        showToast('Error fetching passwords.', 'error');
      });
    }

    // --- Event Listeners ---

    // Login/Signup logic
    function handleAuth(isSignUp) {
      const mobile = countryCode.value + mobileInput.value.trim();
      const password = passwordInput.value.trim();
      const userRef = doc(db, `artifacts/${appId}/public/data/users`, mobile);

      if (!validateMobile(mobileInput.value.trim())) {
        mobileError.classList.remove('hidden');
        return;
      }
      mobileError.classList.add('hidden');

      if (!password) {
        showToast('Password cannot be empty.', 'error');
        return;
      }

      const processAuth = async () => {
        try {
          const userSnap = await getDoc(userRef);
          if (isSignUp) {
            if (userSnap.exists()) {
              showToast('Account with this mobile number already exists.', 'error');
            } else {
              await setDoc(userRef, { password, userId: auth.currentUser.uid });
              showToast('Sign up successful!');
              // No need to call switchToPasswordManager here, the onAuthStateChanged listener will handle it.
            }
          } else { // Login
            if (userSnap.exists() && userSnap.data().password === password) {
              showToast('Login successful!');
              // No need to call switchToPasswordManager here, the onAuthStateChanged listener will handle it.
            } else {
              showToast('Invalid mobile number or password.', 'error');
            }
          }
        } catch (error) {
          console.error("Authentication error:", error);
          showToast('An error occurred during authentication.', 'error');
        }
      };

      processAuth();
    }

    loginBtn.onclick = () => handleAuth(false);
    signupBtn.onclick = () => handleAuth(true);

    forgotBtn.onclick = () => {
      showModal(
        'Forgot Password',
        'In a real application, a password reset link would be sent to your registered email or phone number. For this demo, please remember your password.',
        [
          { text: 'OK', className: 'bg-blue-600 text-white hover:bg-blue-700' }
        ]
      );
    };

    logoutBtn.onclick = async () => {
      showModal(
        'Log Out',
        'Are you sure you want to log out?',
        [
          { text: 'Cancel', className: 'bg-gray-200 text-gray-800 hover:bg-gray-300' },
          { text: 'Log Out', className: 'bg-red-500 text-white hover:bg-red-600', action: async () => {
            try {
              await signOut(auth);
              if (passwordsUnsubscribe) {
                passwordsUnsubscribe(); // Stop listening for changes
              }
              switchToLogin();
              showToast('Logged out successfully.');
            } catch (error) {
              console.error("Error signing out:", error);
              showToast('Error logging out.', 'error');
            }
          }}
        ]
      );
    };

    addPasswordForm.onsubmit = (e) => {
      e.preventDefault();
      const passwordData = {
        website: newWebsiteInput.value.trim(),
        username: newUsernameInput.value.trim(),
        password: newPasswordInput.value.trim()
      };
      addPassword(passwordData);
      addPasswordForm.reset();
    };

    exportBtn.onclick = async () => {
      try {
        const passwordsSnapshot = await getDocs(collection(db, `artifacts/${appId}/users/${userId}/passwords`));
        const passwords = passwordsSnapshot.docs.map(doc => doc.data());

        if (passwords.length === 0) {
          showToast('No passwords to export.', 'error');
          return;
        }

        const zip = new JSZip();
        const jsonData = JSON.stringify(passwords, null, 2);
        const txtData = passwords.map(p => `Website: ${p.website}\nUsername: ${p.username}\nPassword: ${p.password}`).join('\n\n');
        zip.file('passwords.json', jsonData);
        zip.file('passwords.txt', txtData);

        zip.generateAsync({ type: 'blob' }).then(content => {
          saveAs(content, 'passwords.zip');
          showToast('Passwords exported!');
        });
      } catch (error) {
        console.error("Export failed:", error);
        showToast('Export failed.', 'error');
      }
    };

    importFile.onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      try {
        let importedData = [];
        if (file.name.endsWith('.json')) {
          importedData = JSON.parse(await file.text());
        } else if (file.name.endsWith('.zip')) {
          const zip = await JSZip.loadAsync(file);
          const jsonFile = zip.file('passwords.json');
          if (jsonFile) {
            importedData = JSON.parse(await jsonFile.async('text'));
          } else {
            showToast('Zip file does not contain a passwords.json file.', 'error');
            return;
          }
        }

        if (!Array.isArray(importedData)) {
          showToast('Imported file has an invalid format.', 'error');
          return;
        }

        for (const item of importedData) {
          if (item.website && item.username && item.password) {
            await addDoc(collection(db, `artifacts/${appId}/users/${userId}/passwords`), item);
          }
        }
        showToast('Passwords imported successfully!');
      } catch (error) {
        console.error("Import failed:", error);
        showToast('Import failed.', 'error');
      } finally {
        e.target.value = ''; // Reset file input
      }
    };

    // --- UI State Management ---

    function switchToPasswordManager() {
      loginSection.classList.add('hidden');
      passwordManager.classList.remove('hidden');
      userIdContainer.classList.remove('hidden');
      userIdDisplay.textContent = userId;
      setupPasswordListener();
    }

    function switchToLogin() {
      loginSection.classList.remove('hidden');
      passwordManager.classList.add('hidden');
      userIdContainer.classList.add('hidden');
    }

    if (Object.keys(firebaseConfig).length > 0) {
      const firebaseApp = initializeApp(firebaseConfig);
      db = getFirestore(firebaseApp);
      auth = getAuth(firebaseApp);

      setLogLevel('debug');

      onAuthStateChanged(auth, async (user) => {
        if (user) {
          userId = user.uid;
          switchToPasswordManager();
        } else {
          // Sign in anonymously if no auth token is provided
          try {
            await signInAnonymously(auth);
            userId = auth.currentUser.uid;
            switchToPasswordManager();
          } catch (error) {
            console.error("Anonymous sign-in failed:", error);
            // Fallback to login if anonymous sign-in also fails
            switchToLogin();
          }
        }
      });

      // Sign in with the custom token if it exists
      if (initialAuthToken) {
        signInWithCustomToken(auth, initialAuthToken).catch((error) => {
          console.error("Custom token sign-in failed:", error);
          // Fallback to anonymous sign-in if custom token fails
          signInAnonymously(auth).catch(anonErr => console.error("Anonymous sign-in also failed:", anonErr));
        });
      }
    }
  </script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center font-sans">
  <!-- Main Container -->
  <div class="w-full max-w-md bg-white rounded-2xl shadow-lg p-6">
    <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Password Locker</h1>

    <!-- Authentication Section -->
    <div id="auth-container" class="space-y-4">
      <div id="login-section" class="space-y-4">
        <label for="mobileInput" class="block text-gray-700 font-semibold">Mobile Number</label>
        <div class="flex items-center rounded-lg overflow-hidden border border-gray-300">
          <select id="countryCode" class="bg-gray-100 p-3 border-r border-gray-300 focus:outline-none">
            <option value="+1" data-length="10">ðŸ‡ºðŸ‡¸ +1</option>
            <option value="+44" data-length="10">ðŸ‡¬ðŸ‡§ +44</option>
            <option value="+91" data-length="10">ðŸ‡®ðŸ‡³ +91</option>
            <option value="+61" data-length="9">ðŸ‡¦ðŸ‡º +61</option>
            <option value="+81" data-length="10">ðŸ‡¯ðŸ‡µ +81</option>
            <option value="+49" data-length="11">ðŸ‡©ðŸ‡ª +49</option>
            <option value="+33" data-length="9">ðŸ‡«ðŸ‡· +33</option>
            <option value="+39" data-length="10">ðŸ‡®ðŸ‡¹ +39</option>
            <option value="+974" data-length="8">ðŸ‡¶ðŸ‡¦ +974</option>
          </select>
          <input type="tel" id="mobileInput" placeholder="Enter number" class="flex-1 p-3 focus:outline-none" />
        </div>
        <p id="mobileError" class="text-red-500 text-sm hidden">Invalid mobile number</p>

        <label for="passwordInput" class="block text-gray-700 font-semibold">Password</label>
        <input type="password" id="passwordInput" placeholder="Enter password" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />

        <div class="flex space-x-4">
          <button id="loginBtn" class="flex-1 bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-blue-700 transition duration-300">Login</button>
          <button id="signupBtn" class="flex-1 bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-green-700 transition duration-300">Sign Up</button>
        </div>
        <button id="forgotBtn" class="w-full bg-yellow-400 text-black font-bold py-3 px-4 rounded-lg shadow-md hover:bg-yellow-500 transition duration-300">Forgot Password</button>
      </div>

      <!-- User ID Display -->
      <div id="user-id-container" class="hidden">
        <p class="text-center text-xs text-gray-500 mt-4">
          Logged in as: <span id="userIdDisplay" class="font-mono text-xs text-gray-700 break-all"></span>
        </p>
      </div>
    </div>

    <!-- Password Manager Section -->
    <div id="password-manager" class="hidden space-y-6">
      <div class="flex justify-between items-center">
        <h2 class="text-xl font-bold text-gray-800">Saved Passwords</h2>
        <button id="logoutBtn" class="text-red-500 hover:text-red-700 text-sm transition duration-300">Log Out</button>
      </div>

      <!-- Add New Password Form -->
      <form id="add-password-form" class="bg-gray-50 rounded-lg p-4 shadow-inner space-y-3">
        <h3 class="font-bold text-gray-700">Add New Password</h3>
        <div>
          <label for="newWebsite" class="block text-sm text-gray-600">Website</label>
          <input type="text" id="newWebsite" required class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500" />
        </div>
        <div>
          <label for="newUsername" class="block text-sm text-gray-600">Username</label>
          <input type="text" id="newUsername" required class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500" />
        </div>
        <div>
          <label for="newPassword" class="block text-sm text-gray-600">Password</label>
          <input type="password" id="newPassword" required class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500" />
        </div>
        <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 rounded-md hover:bg-blue-700 transition duration-300">Save Password</button>
      </form>

      <!-- Saved Passwords List -->
      <div id="savedList" class="space-y-3 mt-6"></div>

      <!-- Export/Import Buttons -->
      <div class="flex flex-col space-y-2 mt-6">
        <button id="exportBtn" class="bg-purple-600 text-white font-bold p-3 rounded-lg shadow-md hover:bg-purple-700 transition duration-300">Export All (ZIP: JSON + TXT)</button>
        <label for="importFile" class="w-full bg-yellow-500 text-white font-bold p-3 rounded-lg shadow-md hover:bg-yellow-600 transition duration-300 text-center cursor-pointer">
          Import (ZIP/JSON)
        </label>
        <input type="file" id="importFile" accept=".zip,.json" class="hidden" />
      </div>
    </div>

    <!-- Toast Notification Container -->
    <div id="toast-container" class="fixed bottom-4 right-4 space-y-2 z-50"></div>

    <!-- Custom Modal/Dialog -->
    <div id="customModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
      <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-sm transform scale-95 transition-transform duration-300">
        <h3 id="modalTitle" class="text-xl font-bold mb-4"></h3>
        <p id="modalMessage" class="mb-6"></p>
        <div id="modalActions" class="flex justify-end space-x-2">
          <!-- Action buttons will be added here dynamically -->
        </div>
      </div>
    </div>
  </div>
</body>
</html>
