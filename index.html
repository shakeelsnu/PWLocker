<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Password Locker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
  <div class="w-full max-w-md bg-white rounded-2xl shadow-lg p-6" id="auth-container">
    <h1 class="text-2xl font-bold mb-4 text-center">Password Locker</h1>
    <div id="login-section">
      <label class="block mb-2">Mobile Number (with country code)</label>
      <div class="flex items-center mb-2">
        <select id="countryCode" class="p-2 border rounded-l">
          <option value="+1" data-length="10">ðŸ‡ºðŸ‡¸ +1</option>
          <option value="+44" data-length="10">ðŸ‡¬ðŸ‡§ +44</option>
          <option value="+91" data-length="10">ðŸ‡®ðŸ‡³ +91</option>
          <option value="+61" data-length="9">ðŸ‡¦ðŸ‡º +61</option>
          <option value="+81" data-length="10">ðŸ‡¯ðŸ‡µ +81</option>
          <option value="+49" data-length="11">ðŸ‡©ðŸ‡ª +49</option>
          <option value="+33" data-length="9">ðŸ‡«ðŸ‡· +33</option>
          <option value="+39" data-length="10">ðŸ‡®ðŸ‡¹ +39</option>
          <option value="+974" data-length="8">ðŸ‡¶ðŸ‡¦ +974</option>
        </select>
        <input type="tel" id="mobileInput" placeholder="12345678" class="flex-1 p-2 border-t border-b border-r rounded-r" />
      </div>
      <p id="mobileError" class="text-red-500 text-sm hidden">Invalid mobile number</p>

      <label class="block mb-2">Password</label>
      <input type="password" id="passwordInput" placeholder="Password (4-6 digits)" class="w-full p-2 border rounded mb-4" />

      <label class="block mb-2">Email (for password recovery)</label>
      <input type="email" id="emailInput" placeholder="you@example.com" class="w-full p-2 border rounded mb-4" />

      <button id="loginBtn" class="w-full bg-blue-500 text-white p-2 rounded mb-2">Login</button>
      <button id="signupBtn" class="w-full bg-green-500 text-white p-2 rounded mb-2">Sign Up</button>
      <button id="forgotBtn" class="w-full bg-yellow-500 text-black p-2 rounded">Forgot Password</button>
    </div>

    <div id="password-manager" class="hidden">
      <h2 class="text-xl font-bold mb-4">Saved Passwords</h2>
      <div class="mb-4">
        <input type="text" id="websiteInput" placeholder="Website" class="w-full p-2 border rounded mb-2" />
        <input type="text" id="usernameInput" placeholder="Username" class="w-full p-2 border rounded mb-2" />
        <input type="password" id="newPasswordInput" placeholder="Password" class="w-full p-2 border rounded mb-2" />
        <button id="addPasswordBtn" class="w-full bg-blue-500 text-white p-2 rounded">Add Password</button>
      </div>
      <div id="savedList" class="space-y-2"></div>
      <button id="exportBtn" class="w-full bg-purple-500 text-white p-2 rounded mt-4">Export All (ZIP: JSON + TXT)</button>
      <input type="file" id="importFile" accept=".zip,.json" class="hidden" />
      <button id="importBtn" class="w-full bg-yellow-500 text-white p-2 rounded mt-2">Import (ZIP/JSON)</button>
      <button id="logoutBtn" class="w-full bg-red-500 text-white p-2 rounded mt-2">Logout</button>
    </div>
  </div>

  <div id="toast-container" class="fixed bottom-4 right-4 space-y-2 z-50"></div>

  <script>
    const loginBtn = document.getElementById('loginBtn');
    const signupBtn = document.getElementById('signupBtn');
    const forgotBtn = document.getElementById('forgotBtn');
    const mobileInput = document.getElementById('mobileInput');
    const countryCode = document.getElementById('countryCode');
    const passwordInput = document.getElementById('passwordInput');
    const emailInput = document.getElementById('emailInput');
    const mobileError = document.getElementById('mobileError');
    const addPasswordBtn = document.getElementById('addPasswordBtn');
    const websiteInput = document.getElementById('websiteInput');
    const usernameInput = document.getElementById('usernameInput');
    const newPasswordInput = document.getElementById('newPasswordInput');
    const importFile = document.getElementById('importFile');
    const importBtn = document.getElementById('importBtn');
    const logoutBtn = document.getElementById('logoutBtn');

    const passwordManager = document.getElementById('password-manager');
    const savedList = document.getElementById('savedList');
    const exportBtn = document.getElementById('exportBtn');

    let savedPasswords = [];
    let currentUser = null;

    // Initialize from localStorage
    function loadUserData() {
      const autoLogin = localStorage.getItem('autoLogin');
      if (autoLogin) {
        try {
          const { mobile, pw } = JSON.parse(autoLogin);
          const storedPw = localStorage.getItem(`pw_${mobile}`);
          
          if (storedPw && storedPw === pw) {
            currentUser = mobile;
            const userData = localStorage.getItem(`data_${mobile}`);
            savedPasswords = userData ? JSON.parse(userData) : [];
            
            document.getElementById('login-section').classList.add('hidden');
            passwordManager.classList.remove('hidden');
            renderPasswords();
          }
        } catch (e) {
          console.error('Error loading user data:', e);
          localStorage.removeItem('autoLogin');
        }
      }
    }

    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `p-3 rounded shadow text-white ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
      toast.innerText = message;
      document.getElementById('toast-container').appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    function validateMobile(number) {
      const countryOption = countryCode.options[countryCode.selectedIndex];
      const expectedLength = parseInt(countryOption.dataset.length);
      const digitsOnly = number.replace(/\D/g, '');
      return digitsOnly.length === expectedLength;
    }

    function renderPasswords() {
      savedList.innerHTML = '';
      if (savedPasswords.length === 0) {
        savedList.innerHTML = '<p class="text-gray-500 text-center py-4">No passwords saved yet</p>';
        return;
      }
      
      savedPasswords.forEach((item, idx) => {
        const div = document.createElement('div');
        div.className = 'border p-2 rounded bg-gray-50';
        div.innerHTML = `
          <p><strong>Website:</strong> ${item.website}</p>
          <p><strong>Username:</strong> ${item.username}</p>
          <p><strong>Password:</strong> ${item.password}</p>
          <button class="bg-red-500 text-white px-2 py-1 rounded mt-2 delete-btn" data-index="${idx}">Delete</button>
        `;
        savedList.appendChild(div);
      });
      
      // Add event listeners to delete buttons
      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const index = parseInt(this.getAttribute('data-index'));
          deletePassword(index);
        });
      });
    }

    function deletePassword(idx) {
      if (confirm('Are you sure you want to delete this saved password?')) {
        savedPasswords.splice(idx, 1);
        localStorage.setItem(`data_${currentUser}`, JSON.stringify(savedPasswords));
        renderPasswords();
        showToast('Deleted successfully');
      }
    }

    loginBtn.addEventListener('click', () => {
      const mobile = countryCode.value + mobileInput.value.trim();
      const pw = passwordInput.value.trim();
      
      if (!validateMobile(mobileInput.value.trim())) { 
        mobileError.classList.remove('hidden'); 
        return; 
      }
      mobileError.classList.add('hidden');

      const storedPw = localStorage.getItem(`pw_${mobile}`);
      if (storedPw && storedPw === pw) {
        currentUser = mobile;
        const userData = localStorage.getItem(`data_${mobile}`);
        savedPasswords = userData ? JSON.parse(userData) : [];
        
        document.getElementById('login-section').classList.add('hidden');
        passwordManager.classList.remove('hidden');
        renderPasswords();
        showToast('Login successful');
        localStorage.setItem('autoLogin', JSON.stringify({ mobile, pw }));
      } else {
        showToast('Wrong password or user not found', 'error');
      }
    });

    signupBtn.addEventListener('click', () => {
      const mobile = countryCode.value + mobileInput.value.trim();
      const pw = passwordInput.value.trim();
      const email = emailInput.value.trim();

      if (!validateMobile(mobileInput.value.trim())) { 
        mobileError.classList.remove('hidden'); 
        return; 
      }
      mobileError.classList.add('hidden');
      
      if (!email) { 
        showToast('Email required', 'error'); 
        return; 
      }
      
      if (!/^\d{4,6}$/.test(pw)) { 
        showToast('Password must be 4â€“6 digits', 'error'); 
        return; 
      }

      // Check if user already exists
      if (localStorage.getItem(`pw_${mobile}`)) {
        showToast('User already exists. Please login instead.', 'error');
        return;
      }

      localStorage.setItem(`pw_${mobile}`, pw);
      localStorage.setItem(`email_${mobile}`, email);
      localStorage.setItem(`data_${mobile}`, JSON.stringify([]));
      
      currentUser = mobile;
      savedPasswords = [];
      
      showToast('Signed up successfully');
      localStorage.setItem('autoLogin', JSON.stringify({ mobile, pw }));

      // Show password manager after signup
      document.getElementById('login-section').classList.add('hidden');
      passwordManager.classList.remove('hidden');
      renderPasswords();
    });

    forgotBtn.addEventListener('click', () => {
      const mobile = countryCode.value + mobileInput.value.trim();
      if (!validateMobile(mobileInput.value.trim())) { 
        mobileError.classList.remove('hidden'); 
        return; 
      }
      mobileError.classList.add('hidden');
      
      const email = localStorage.getItem(`email_${mobile}`);
      const pw = localStorage.getItem(`pw_${mobile}`);
      
      if (email && pw) {
        const enteredEmail = prompt('Enter your registered email:');
        if (enteredEmail === email) {
          setTimeout(() => alert(`Password for ${mobile} sent to ${email}: ${pw}`), 100);
        } else {
          showToast('Email does not match', 'error');
        }
      } else {
        showToast('No account found for this mobile number', 'error');
      }
    });

    addPasswordBtn.addEventListener('click', () => {
      const website = websiteInput.value.trim();
      const username = usernameInput.value.trim();
      const password = newPasswordInput.value.trim();
      
      if (!website || !username || !password) {
        showToast('All fields are required', 'error');
        return;
      }
      
      savedPasswords.push({ website, username, password });
      localStorage.setItem(`data_${currentUser}`, JSON.stringify(savedPasswords));
      
      websiteInput.value = '';
      usernameInput.value = '';
      newPasswordInput.value = '';
      
      renderPasswords();
      showToast('Password saved successfully');
    });

    exportBtn.addEventListener('click', () => {
      if (savedPasswords.length === 0) {
        showToast('No passwords to export', 'error');
        return;
      }
      
      const zip = new JSZip();
      const jsonData = JSON.stringify(savedPasswords, null, 2);
      const txtData = savedPasswords.map(p => `Website: ${p.website}\nUsername: ${p.username}\nPassword: ${p.password}`).join('\n\n');
      
      zip.file('passwords.json', jsonData);
      zip.file('passwords.txt', txtData);
      
      zip.generateAsync({ type: 'blob' })
        .then(content => {
          saveAs(content, 'passwords.zip');
          showToast('Export completed successfully');
        })
        .catch(err => {
          console.error('Export error:', err);
          showToast('Export failed', 'error');
        });
    });

    importBtn.addEventListener('click', () => {
      importFile.click();
    });

    importFile.addEventListener('change', (event) => {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          let importedData;
          
          if (file.name.endsWith('.zip')) {
            // ZIP file handling would require more complex processing
            showToast('ZIP import not fully implemented in this version', 'error');
            return;
          } else if (file.name.endsWith('.json')) {
            importedData = JSON.parse(e.target.result);
          } else {
            showToast('Unsupported file format', 'error');
            return;
          }
          
          if (!Array.isArray(importedData)) {
            showToast('Invalid file format', 'error');
            return;
          }
          
          // Merge imported data with existing passwords
          savedPasswords = [...savedPasswords, ...importedData];
          localStorage.setItem(`data_${currentUser}`, JSON.stringify(savedPasswords));
          renderPasswords();
          showToast('Import completed successfully');
        } catch (err) {
          console.error('Import error:', err);
          showToast('Failed to import file', 'error');
        }
      };
      reader.readAsText(file);
    });

    logoutBtn.addEventListener('click', () => {
      localStorage.removeItem('autoLogin');
      currentUser = null;
      savedPasswords = [];
      
      passwordManager.classList.add('hidden');
      document.getElementById('login-section').classList.remove('hidden');
      
      // Clear input fields
      mobileInput.value = '';
      passwordInput.value = '';
      emailInput.value = '';
      
      showToast('Logged out successfully');
    });

    // Initialize the application
    loadUserData();
  </script>
</body>
</html>
